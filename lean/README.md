# QuantConnect Lean Backtest Project

This directory contains the QuantConnect Lean algorithm that consumes signals generated by the LangGraph pipeline.

## Structure

```
lean/
├── lean.json                    # Lean configuration
├── Algorithm.Python/
│   └── RegimeSignalsAlgo.py    # Main algorithm
├── data/
│   └── alternative/
│       └── my_signals/         # Symlink to ../../data/signals/latest
└── backtests/                   # Output directory (auto-created)
```

## Setup

### Prerequisites

1. **Docker Desktop**: Install from [docker.com](https://www.docker.com/)
2. **Lean CLI**: Install via pip
   ```bash
   pip install lean
   ```

### Initialize Project

If this is your first time:

```bash
cd lean
lean init
```

### Create Signals Symlink

The algorithm reads signals from `data/alternative/my_signals/signals.csv`. Create a symlink:

```bash
# From project root
python -c "from src.bridges.lean_gateway import ensure_lean_data_symlink; from pathlib import Path; ensure_lean_data_symlink(Path('data/signals/latest'))"
```

Or manually:

```bash
cd lean/data/alternative
ln -s ../../../data/signals/latest my_signals
```

## Usage

### 1. Generate Signals

First, run the pipeline to generate signals:

```bash
# From project root
python -m src.ui.cli analyze BTC-USD --mode thorough

# Or enable signals export in config/settings.yaml:
# lean:
#   export_signals: true
```

This creates `data/signals/latest/signals.csv`.

### 2. Run Backtest

```bash
cd lean
lean backtest "RegimeSignalsAlgo"
```

Results will be in `lean/backtests/<timestamp>/`.

### 3. Evaluate Against Gates

```bash
# From project root
python -m src.gates.evaluate_backtest \
  --company config/company.acme.yaml \
  --backtest lean/backtests/<timestamp>/backtest.json
```

## Configuration

### Company Config

Customize requirements in `config/company.<name>.yaml`:

- Universe (symbols)
- Date range
- Minimum CAGR, Sharpe, Max DD
- Avg profit per trade threshold

### Algorithm Parameters

Edit `lean.json` or override via CLI:

```bash
lean backtest "RegimeSignalsAlgo" \
  --start "20200101" \
  --end "20250101"
```

## Troubleshooting

### Signals CSV Not Found

```
Error: Could not find data/alternative/my_signals/signals.csv
```

**Solution**: Ensure symlink exists and signals have been generated.

```bash
# Check symlink
ls -la lean/data/alternative/my_signals

# Re-create if needed
cd lean/data/alternative
rm -f my_signals
ln -s ../../../data/signals/latest my_signals
```

### No Data For Symbol

```
Error: No data available for BTCUSD
```

**Solution**: Lean requires historical data. Either:
1. Use Lean's free data: `lean data download`
2. Use your own data in `data/` directory

### Docker Issues

```
Error: Cannot connect to Docker daemon
```

**Solution**: Ensure Docker Desktop is running.

## Next Steps

- **Enhance Portfolio Model**: Implement proper volatility targeting in `PortfolioModels.py`
- **Add Cost Models**: Incorporate realistic spreads, slippage, fees
- **Walk-Forward**: Implement rolling optimization windows
- **Live Trading**: Configure live data sources and execution

## Resources

- [QuantConnect Docs](https://www.quantconnect.com/docs/)
- [Lean CLI Guide](https://www.quantconnect.com/docs/v2/lean-cli)
- [Python Algorithm API](https://www.quantconnect.com/docs/v2/writing-algorithms)

